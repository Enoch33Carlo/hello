// routes/reportRoutes.js
import express from "express";
import PDFDocument from "pdfkit";
import fs from "fs";
import path from "path";
import db from "../db.js";
import cors from "cors";

const router = express.Router();

// Utility: mock AI summary generator
function generateFakeAIInsight(event, totalRegs, totalCash) {
  return `
The event "${event.title}" in the category "${event.category}" was successfully organized 
on ${event.date}. It achieved good student participation with ${totalRegs} total registrations.

üí° AI Summary:
- The engagement level was impressive given the event‚Äôs academic focus.
- The total amount collected (‚Çπ${totalCash}) indicates strong community support.
- For future improvement, consider expanding promotion to other departments 
  and offering early-bird registration incentives.

Overall, this event showcased effective planning and execution within the institution.
  `;
}

router.post("/generate", async (req, res) => {
  const { eventId } = req.body;

  try {
    // 1Ô∏è‚É£ Fetch event details
    const [eventData] = await db.execute("SELECT * FROM events WHERE id = ?", [eventId]);
    if (eventData.length === 0) return res.status(404).json({ message: "Event not found" });
    const event = eventData[0];

    // 2Ô∏è‚É£ Fetch registrations
    const [registrations] = await db.execute(
      "SELECT * FROM registrations WHERE eventId = ?",
      [eventId]
    );

    // 3Ô∏è‚É£ Fetch finance data
    const [financeData] = await db.execute("SELECT * FROM finance WHERE eventId = ?", [eventId]);
    const finance = financeData[0] || { cashCollected: 0, onlineCollected: 0 };
    const totalCollected = Number(finance.cashCollected) + Number(finance.onlineCollected);

    // 4Ô∏è‚É£ Generate AI-like insight (mock)
    const aiInsight = generateFakeAIInsight(event, registrations.length, totalCollected);

    // 5Ô∏è‚É£ Generate PDF
    const doc = new PDFDocument({ margin: 50 });
    const pdfPath = path.join("public", `EventReport_${event.title}.pdf`);
    const writeStream = fs.createWriteStream(pdfPath);
    doc.pipe(writeStream);

    // Header
    doc.fontSize(22).text("üéì AI Campus Event Report", { align: "center" });
    doc.moveDown();

    // Event Info
    doc.fontSize(14).text(`Event: ${event.title}`);
    doc.text(`Category: ${event.category}`);
    doc.text(`Date: ${event.date}`);
    doc.text(`Venue: ${event.venue || "N/A"}`);
    doc.text(`Location: ${event.location || "N/A"}`);
    doc.moveDown();

    // Financial
    doc.fontSize(14).text("üí∞ Financial Summary");
    doc.text(`Cash Collected: ‚Çπ${finance.cashCollected}`);
    doc.text(`Online Collected: ‚Çπ${finance.onlineCollected}`);
    doc.text(`Total Collected: ‚Çπ${totalCollected}`);
    doc.moveDown();

    // Registration
    doc.fontSize(14).text("üë• Registrations");
    doc.text(`Total Registered Students: ${registrations.length}`);
    doc.moveDown();

    // AI Summary
    doc.fontSize(14).text("üí° AI Insight", { underline: true });
    doc.moveDown(0.5);
    doc.fontSize(12).text(aiInsight, { align: "justify" });
    doc.moveDown(1);

    // Footer
    doc.fontSize(10).text("Generated by AI Campus Event Monitoring System", {
      align: "center",
      opacity: 0.6,
    });

    doc.end();

    writeStream.on("finish", () => {
      res.download(pdfPath);
    });
  } catch (error) {
    console.error("‚ùå Error generating report:", error);
    res.status(500).json({ message: "Error generating report" });
  }
});

export default router; 